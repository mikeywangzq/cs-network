# ğŸŒ Simple P2P File Sharing Tool

ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ P2P æ–‡ä»¶åˆ†äº«å·¥å…·ï¼Œæ¨¡ä»¿ BitTorrent çš„æ ¸å¿ƒæ€æƒ³ã€‚è¿™æ˜¯ä¸€ä¸ªæ•™è‚²æ€§é¡¹ç›®ï¼Œä½¿ç”¨ C++ å’Œåº•å±‚ TCP Socket API å®ç°ï¼Œä¸ä¾èµ–ä»»ä½•é«˜çº§ P2P åº“ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [åè®®è¯´æ˜](#åè®®è¯´æ˜)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [æµ‹è¯•ç¤ºä¾‹](#æµ‹è¯•ç¤ºä¾‹)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)
- [å­¦ä¹ è¦ç‚¹](#å­¦ä¹ è¦ç‚¹)

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

è¿™ä¸ªé¡¹ç›®å®ç°äº†ä¸€ä¸ªæç®€çš„ P2P æ–‡ä»¶åˆ†äº«ç³»ç»Ÿï¼ŒåŒ…å«ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

1. **Tracker æœåŠ¡å™¨** (`tracker.cpp`)
   - ä¸­å¿ƒåŒ–çš„åè°ƒæœåŠ¡å™¨
   - ç»´æŠ¤æ–‡ä»¶å’Œ Peer çš„æ˜ å°„å…³ç³»
   - å¸®åŠ© Peer ä¹‹é—´ç›¸äº’å‘ç°

2. **Peer å®¢æˆ·ç«¯** (`peer.cpp`)
   - åŒæ—¶æ‰®æ¼”å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨è§’è‰²
   - æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘ä¸‹è½½/ä¸Šä¼ 
   - å®ç°å®Œæ•´çš„ P2P åè®®æ ˆ

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ”§ æŠ€æœ¯ç‰¹æ€§

- âœ… **çº¯ C++ å®ç°**ï¼šä½¿ç”¨ POSIX Socket APIï¼Œä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“
- âœ… **å¤šçº¿ç¨‹æ¶æ„**ï¼šæœåŠ¡å™¨çº¿ç¨‹ + ä¸‹è½½çº¿ç¨‹ + è¿æ¥å¤„ç†çº¿ç¨‹
- âœ… **æ–‡ä»¶åˆ†ç‰‡**ï¼š64KB å›ºå®šå¤§å°çš„ç‰‡æ®µï¼ˆPieceï¼‰
- âœ… **ä½åŸŸç®¡ç†**ï¼šé«˜æ•ˆçš„ç‰‡æ®µæ‹¥æœ‰æƒ…å†µè¿½è¸ª
- âœ… **è‡ªå®šä¹‰åè®®**ï¼šTracker åè®® + P2P åè®®
- âœ… **å¹¶å‘å®‰å…¨**ï¼šäº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®ç»“æ„

### ğŸš€ åŠŸèƒ½ç‰¹æ€§

- ğŸ“¥ **å¤šæºä¸‹è½½**ï¼šä»å¤šä¸ª Peer åŒæ—¶ä¸‹è½½ä¸åŒç‰‡æ®µ
- ğŸ“¤ **è‡ªåŠ¨åˆ†äº«**ï¼šä¸‹è½½å®Œæˆåè‡ªåŠ¨æˆä¸ºç§å­
- ğŸ”„ **å®æ—¶æ›´æ–°**ï¼šåŠ¨æ€æ›´æ–° Peer åˆ—è¡¨å’Œä½åŸŸä¿¡æ¯
- ğŸ›¡ï¸ **å¥å£®æ€§**ï¼šæ­£ç¡®å¤„ç†ç½‘ç»œé”™è¯¯å’Œéƒ¨åˆ†ä¼ è¾“

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Tracker Server                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  File-Peer Mapping:                                   â”‚  â”‚
â”‚  â”‚  {                                                     â”‚  â”‚
â”‚  â”‚    "file1": [(IP1, Port1, Bitfield1),                â”‚  â”‚
â”‚  â”‚              (IP2, Port2, Bitfield2), ...]           â”‚  â”‚
â”‚  â”‚    "file2": [...]                                     â”‚  â”‚
â”‚  â”‚  }                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–² â–¼
                    Tracker Protocol
                      (REGISTER, GETPEERS, UPDATE)
                          â–² â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Peer Node                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Server Thread â”‚  â”‚ Downloader     â”‚  â”‚  Main Thread â”‚  â”‚
â”‚  â”‚  (Listen for   â”‚  â”‚ Thread         â”‚  â”‚  (Control)   â”‚  â”‚
â”‚  â”‚   incoming     â”‚  â”‚ (Connect to    â”‚  â”‚              â”‚  â”‚
â”‚  â”‚   connections) â”‚  â”‚  other peers)  â”‚  â”‚              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Bitfield: [1,1,0,1,0,0,1,1,...]                     â”‚  â”‚
â”‚  â”‚  (Tracks which pieces this peer has)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–² â–¼
                      P2P Protocol
        (HANDSHAKE, BITFIELD, REQUEST, PIECE, HAVE)
                          â–² â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Other Peer Nodes                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çº¿ç¨‹æ¨¡å‹

#### Tracker Server
```
Main Thread
    â”‚
    â”œâ”€â”€> Accept Loop
    â”‚      â”‚
    â”‚      â”œâ”€â”€> Client Handler Thread 1
    â”‚      â”œâ”€â”€> Client Handler Thread 2
    â”‚      â””â”€â”€> Client Handler Thread N
    â”‚
    â””â”€â”€> [Waits indefinitely]
```

#### Peer Client
```
Main Thread
    â”‚
    â”œâ”€â”€> Server Thread
    â”‚      â”‚
    â”‚      â”œâ”€â”€> Accept Loop
    â”‚      â”‚      â”‚
    â”‚      â”‚      â”œâ”€â”€> Connection Handler 1
    â”‚      â”‚      â”œâ”€â”€> Connection Handler 2
    â”‚      â”‚      â””â”€â”€> Connection Handler N
    â”‚      â”‚
    â”‚      â””â”€â”€> [Runs indefinitely]
    â”‚
    â”œâ”€â”€> Downloader Thread (if in download mode)
    â”‚      â”‚
    â”‚      â”œâ”€â”€> Get Peers from Tracker
    â”‚      â”œâ”€â”€> Connect to Peer 1
    â”‚      â”œâ”€â”€> Connect to Peer 2
    â”‚      â”œâ”€â”€> Connect to Peer N
    â”‚      â””â”€â”€> [Loops until download complete]
    â”‚
    â””â”€â”€> [Waits for threads]
```

## ğŸ“¡ åè®®è¯´æ˜

### Tracker åè®®ï¼ˆPeer â†” Trackerï¼‰

æ–‡æœ¬åè®®ï¼Œå‘½ä»¤ä»¥ `\n` ç»“å°¾ã€‚

#### 1. REGISTER - æ³¨å†Œåˆ° Tracker
```
Peer -> Tracker:  REGISTER <file_id> <listen_port> <bitfield_hex>\n
Tracker -> Peer:  OK\n
```

**ç¤ºä¾‹ï¼š**
```
REGISTER myfile 7001 FF00F0\n
OK\n
```

#### 2. GETPEERS - è·å– Peer åˆ—è¡¨
```
Peer -> Tracker:  GETPEERS <file_id>\n
Tracker -> Peer:  PEERS <ip1:port1>,<ip2:port2>,...\n
```

**ç¤ºä¾‹ï¼š**
```
GETPEERS myfile\n
PEERS 192.168.1.10:7001,192.168.1.11:7002\n
```

#### 3. UPDATE - æ›´æ–°ç‰‡æ®µä¿¡æ¯
```
Peer -> Tracker:  UPDATE <file_id> <piece_index>\n
Tracker -> Peer:  OK\n
```

**ç¤ºä¾‹ï¼š**
```
UPDATE myfile 5\n
OK\n
```

### P2P åè®®ï¼ˆPeer â†” Peerï¼‰

æ··åˆåè®®ï¼šæ–‡æœ¬å‘½ä»¤ + äºŒè¿›åˆ¶æ•°æ®ã€‚

#### 1. HANDSHAKE - æ¡æ‰‹
```
Initiator -> Responder:  HANDSHAKE <file_id>\n
Responder -> Initiator:  HANDSHAKE_OK\n
```

#### 2. BITFIELD - ä½åŸŸäº¤æ¢
```
Both sides exchange:
BITFIELD <size>\n
<binary_data>  (size bytes)
```

ä½åŸŸæ ¼å¼ï¼šæ¯ä¸ª bit ä»£è¡¨ä¸€ä¸ªç‰‡æ®µï¼Œ1 è¡¨ç¤ºæ‹¥æœ‰ï¼Œ0 è¡¨ç¤ºæ²¡æœ‰ã€‚

**ç¤ºä¾‹ï¼ˆ8 ä¸ªç‰‡æ®µï¼‰ï¼š**
```
BITFIELD 1\n
0xFF  (äºŒè¿›åˆ¶: 11111111 - æ‹¥æœ‰æ‰€æœ‰ 8 ä¸ªç‰‡æ®µ)
```

#### 3. REQUEST - è¯·æ±‚ç‰‡æ®µ
```
Requester -> Provider:  REQUEST <piece_index>\n
```

#### 4. PIECE - å‘é€ç‰‡æ®µ
```
Provider -> Requester:  PIECE <piece_index> <data_size>\n
                        <binary_data>  (data_size bytes)
```

**æ•°æ®æµï¼š**
1. å…ˆå‘é€æ–‡æœ¬å¤´éƒ¨ï¼š`PIECE 5 65536\n`
2. ç´§æ¥ç€å‘é€ 65536 å­—èŠ‚çš„äºŒè¿›åˆ¶æ•°æ®

#### 5. HAVE - å®£å¸ƒæ–°ç‰‡æ®µ
```
Peer -> Connected Peers:  HAVE <piece_index>\n
```

é€šçŸ¥å…¶ä»– Peer è‡ªå·±è·å¾—äº†æ–°ç‰‡æ®µã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Linux ç³»ç»Ÿï¼ˆæˆ–å…¶ä»– POSIX å…¼å®¹ç³»ç»Ÿï¼‰
- G++ ç¼–è¯‘å™¨ï¼ˆæ”¯æŒ C++11ï¼‰
- Make å·¥å…·

### ç¼–è¯‘

```bash
cd BitTorrent
make
```

ç¼–è¯‘æˆåŠŸåä¼šç”Ÿæˆä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼š
- `tracker` - Tracker æœåŠ¡å™¨
- `peer` - Peer å®¢æˆ·ç«¯

### æ¸…ç†

```bash
make clean
```

## ğŸ“– ä½¿ç”¨æŒ‡å—

### 1. å¯åŠ¨ Tracker æœåŠ¡å™¨

åœ¨ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œï¼š

```bash
./tracker [port]
```

**ç¤ºä¾‹ï¼š**
```bash
./tracker 6881
```

é»˜è®¤ç«¯å£ä¸º 6881ã€‚

### 2. å¯åŠ¨ç§å­èŠ‚ç‚¹ï¼ˆSeedï¼‰

æ‹¥æœ‰å®Œæ•´æ–‡ä»¶çš„èŠ‚ç‚¹ï¼š

```bash
./peer seed <file_id> <file_path> <file_size> <listen_port> <tracker_ip> [tracker_port]
```

**å‚æ•°è¯´æ˜ï¼š**
- `seed`: æ¨¡å¼ï¼ˆç§å­æ¨¡å¼ï¼‰
- `file_id`: æ–‡ä»¶æ ‡è¯†ç¬¦
- `file_path`: æ–‡ä»¶è·¯å¾„
- `file_size`: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- `listen_port`: æœ¬åœ°ç›‘å¬ç«¯å£
- `tracker_ip`: Tracker IP åœ°å€
- `tracker_port`: Tracker ç«¯å£ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 6881ï¼‰

**ç¤ºä¾‹ï¼š**
```bash
./peer seed testfile /tmp/myfile.dat 1048576 7001 127.0.0.1 6881
```

### 3. å¯åŠ¨ä¸‹è½½èŠ‚ç‚¹ï¼ˆPeerï¼‰

éœ€è¦ä¸‹è½½æ–‡ä»¶çš„èŠ‚ç‚¹ï¼š

```bash
./peer download <file_id> <file_path> <file_size> <listen_port> <tracker_ip> [tracker_port]
```

**å‚æ•°è¯´æ˜ï¼š**
- `download`: æ¨¡å¼ï¼ˆä¸‹è½½æ¨¡å¼ï¼‰
- å…¶ä»–å‚æ•°åŒä¸Š

**ç¤ºä¾‹ï¼š**
```bash
./peer download testfile /tmp/downloaded.dat 1048576 7002 127.0.0.1 6881
```

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### æ–¹å¼ä¸€ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•

è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬ï¼ˆæ¨èç”¨äºå¿«é€ŸéªŒè¯ï¼‰ï¼š

```bash
./test.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. âœ… ç¼–è¯‘ç¨‹åº
2. âœ… åˆ›å»º 256KB æµ‹è¯•æ–‡ä»¶
3. âœ… å¯åŠ¨ Tracker
4. âœ… å¯åŠ¨ Seed
5. âœ… å¯åŠ¨ Peer 1 å¹¶éªŒè¯ä¸‹è½½
6. âœ… å¯åŠ¨ Peer 2 å¹¶éªŒè¯å¤šæºä¸‹è½½
7. âœ… éªŒè¯æ‰€æœ‰æ–‡ä»¶çš„ MD5 æ ¡éªŒå’Œ

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨äº¤äº’å¼æµ‹è¯•

è¿è¡Œæ¼”ç¤ºè„šæœ¬ï¼ˆæ¨èç”¨äºå­¦ä¹ ç†è§£ï¼‰ï¼š

```bash
./demo.sh
```

è¿™ä¸ªè„šæœ¬ä¼šå¼•å¯¼ä½ é€æ­¥ï¼š
1. åˆ›å»ºæµ‹è¯•æ–‡ä»¶
2. åœ¨ä¸åŒç»ˆç«¯å¯åŠ¨å„ä¸ªç»„ä»¶
3. è§‚å¯Ÿ P2P åè®®çš„å·¥ä½œè¿‡ç¨‹

### æ–¹å¼ä¸‰ï¼šå®Œå…¨æ‰‹åŠ¨æµ‹è¯•

#### æ­¥éª¤ 1ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶

```bash
# åˆ›å»º 1MB æµ‹è¯•æ–‡ä»¶
dd if=/dev/urandom of=/tmp/testfile.dat bs=1024 count=1024

# è·å–æ–‡ä»¶å¤§å°
FILE_SIZE=$(stat -c%s /tmp/testfile.dat)
echo "File size: $FILE_SIZE bytes"
```

#### æ­¥éª¤ 2ï¼šå¯åŠ¨ Trackerï¼ˆç»ˆç«¯ 1ï¼‰

```bash
./tracker 6881
```

#### æ­¥éª¤ 3ï¼šå¯åŠ¨ Seedï¼ˆç»ˆç«¯ 2ï¼‰

```bash
./peer seed myfile /tmp/testfile.dat $FILE_SIZE 7001 127.0.0.1 6881
```

#### æ­¥éª¤ 4ï¼šå¯åŠ¨ä¸‹è½½ Peerï¼ˆç»ˆç«¯ 3ï¼‰

```bash
./peer download myfile /tmp/downloaded.dat $FILE_SIZE 7002 127.0.0.1 6881
```

#### æ­¥éª¤ 5ï¼šéªŒè¯ä¸‹è½½

```bash
# æ¯”è¾ƒåŸå§‹æ–‡ä»¶å’Œä¸‹è½½æ–‡ä»¶çš„æ ¡éªŒå’Œ
md5sum /tmp/testfile.dat
md5sum /tmp/downloaded.dat
```

å¦‚æœä¸¤ä¸ª MD5 å€¼ç›¸åŒï¼Œè¯´æ˜ä¸‹è½½æˆåŠŸï¼

#### æ­¥éª¤ 6ï¼ˆå¯é€‰ï¼‰ï¼šå¯åŠ¨ç¬¬äºŒä¸ªä¸‹è½½ Peerï¼ˆç»ˆç«¯ 4ï¼‰

```bash
./peer download myfile /tmp/downloaded2.dat $FILE_SIZE 7003 127.0.0.1 6881
```

è¿™ä¸ª Peer ä¼šä» Seed å’Œç¬¬ä¸€ä¸ª Peer åŒæ—¶ä¸‹è½½ä¸åŒçš„ç‰‡æ®µï¼

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶åˆ†ç‰‡ï¼ˆPiecingï¼‰

- **ç‰‡æ®µå¤§å°**ï¼š64KB (65536 å­—èŠ‚)
- **ç‰‡æ®µç¼–å·**ï¼šä» 0 å¼€å§‹é€’å¢
- **æœ€åç‰‡æ®µ**ï¼šå¯èƒ½å°äº 64KB

**è®¡ç®—ç‰‡æ®µæ•°é‡ï¼š**
```cpp
num_pieces = (file_size + PIECE_SIZE - 1) / PIECE_SIZE
```

**è®¡ç®—ç‰‡æ®µåç§»ï¼š**
```cpp
offset = piece_index * PIECE_SIZE
```

### ä½åŸŸï¼ˆBitfieldï¼‰

ä½åŸŸæ˜¯ä¸€ä¸ªå¸ƒå°”æ•°ç»„ï¼Œé«˜æ•ˆåœ°è¡¨ç¤º Peer æ‹¥æœ‰å“ªäº›ç‰‡æ®µã€‚

**å†…å­˜è¡¨ç¤ºï¼ˆC++ï¼‰ï¼š**
```cpp
std::vector<bool> bitfield;  // bitfield[i] = true è¡¨ç¤ºæ‹¥æœ‰ç‰‡æ®µ i
```

**åå…­è¿›åˆ¶ç¼–ç ï¼ˆç”¨äº Tracker åè®®ï¼‰ï¼š**
```
ç‰‡æ®µ: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]
ä½åŸŸ: [1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1]
å­—èŠ‚: [11111111][00001111]
åå…­è¿›åˆ¶: "FF0F"
```

**äºŒè¿›åˆ¶ç¼–ç ï¼ˆç”¨äº P2P åè®®ï¼‰ï¼š**
```
ç›´æ¥å‘é€å­—èŠ‚æ•°ç»„ï¼š0xFF 0x0F
```

### ç½‘ç»œç¼–ç¨‹è¦ç‚¹

#### 1. å®Œæ•´å‘é€/æ¥æ”¶

`send()` å’Œ `recv()` å¯èƒ½ä¸ä¼šä¸€æ¬¡æ€§å‘é€/æ¥æ”¶æ‰€æœ‰æ•°æ®ï¼Œéœ€è¦å¾ªç¯å¤„ç†ï¼š

```cpp
bool send_full(int socket, const void* buffer, size_t length) {
    size_t total_sent = 0;
    const char* buf = (const char*)buffer;

    while (total_sent < length) {
        ssize_t sent = send(socket, buf + total_sent,
                           length - total_sent, 0);
        if (sent <= 0) return false;
        total_sent += sent;
    }
    return true;
}
```

#### 2. æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ··åˆåè®®

PIECE æ¶ˆæ¯çš„å¤„ç†ï¼š

```cpp
// 1. æ¥æ”¶æ–‡æœ¬å¤´éƒ¨
std::string header;
recv_line(socket, header);  // "PIECE 5 65536\n"

// 2. è§£æå¤´éƒ¨
parse(header, &piece_index, &data_size);

// 3. æ¥æ”¶äºŒè¿›åˆ¶æ•°æ®
recv_full(socket, buffer, data_size);  // æ°å¥½ data_size å­—èŠ‚
```

#### 3. å¤šçº¿ç¨‹åŒæ­¥

ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«æ•°æ®ï¼š

```cpp
std::mutex g_bitfield_mutex;

void update_bitfield(int piece_index) {
    std::lock_guard<std::mutex> lock(g_bitfield_mutex);
    g_bitfield[piece_index] = true;
}
```

### æ•°æ®ç»“æ„

#### Tracker æœåŠ¡å™¨

```cpp
// æ–‡ä»¶ -> Peer åˆ—è¡¨çš„æ˜ å°„
std::map<std::string, std::vector<PeerInfo>> file_peers_map;

struct PeerInfo {
    std::string ip;
    int port;
    std::string bitfield;  // åå…­è¿›åˆ¶ç¼–ç 
};
```

#### Peer å®¢æˆ·ç«¯

```cpp
std::string g_file_id;              // æ–‡ä»¶ ID
std::string g_file_path;            // æ–‡ä»¶è·¯å¾„
long long g_file_size;              // æ–‡ä»¶å¤§å°
int g_num_pieces;                   // ç‰‡æ®µæ€»æ•°
std::vector<bool> g_bitfield;       // æœ¬åœ°ä½åŸŸ
std::map<std::string, int> g_connected_peers;  // å·²è¿æ¥çš„ Peer
```

## ğŸ“š å­¦ä¹ è¦ç‚¹

è¿™ä¸ªé¡¹ç›®æ¶µç›–äº†ä»¥ä¸‹é‡è¦çš„ç½‘ç»œç¼–ç¨‹æ¦‚å¿µï¼š

### 1. Socket ç¼–ç¨‹åŸºç¡€
- âœ… TCP Socket åˆ›å»ºå’Œé…ç½®
- âœ… `bind()`, `listen()`, `accept()` æœåŠ¡å™¨æ¨¡å‹
- âœ… `connect()` å®¢æˆ·ç«¯è¿æ¥
- âœ… `send()`, `recv()` æ•°æ®ä¼ è¾“
- âœ… åœ°å€ç»“æ„ï¼ˆ`sockaddr_in`ï¼‰

### 2. å¤šçº¿ç¨‹ç¼–ç¨‹
- âœ… `std::thread` åˆ›å»ºå’Œç®¡ç†
- âœ… çº¿ç¨‹åˆ†ç¦»ï¼ˆ`detach()`ï¼‰å’Œè¿æ¥ï¼ˆ`join()`ï¼‰
- âœ… äº’æ–¥é”ï¼ˆ`std::mutex`ï¼‰
- âœ… é”ä¿æŠ¤ï¼ˆ`std::lock_guard`ï¼‰

### 3. P2P ç½‘ç»œåŸç†
- âœ… Tracker ä¸­å¿ƒåŒ–å‘ç°
- âœ… Peer-to-Peer ç›´è¿
- âœ… æ–‡ä»¶åˆ†ç‰‡å’Œå¹¶è¡Œä¸‹è½½
- âœ… ä½åŸŸç®¡ç†å’Œäº¤æ¢

### 4. åè®®è®¾è®¡
- âœ… æ–‡æœ¬åè®®ï¼ˆæ˜“äºè°ƒè¯•ï¼‰
- âœ… äºŒè¿›åˆ¶åè®®ï¼ˆé«˜æ•ˆä¼ è¾“ï¼‰
- âœ… æ··åˆåè®®ï¼ˆçµæ´»æ€§ï¼‰
- âœ… çŠ¶æ€æœºç®¡ç†

### 5. æ–‡ä»¶ I/O
- âœ… éšæœºè®¿é—®ï¼ˆ`seekg()`, `seekp()`ï¼‰
- âœ… äºŒè¿›åˆ¶æ¨¡å¼
- âœ… æ–‡ä»¶é¢„åˆ†é…
- âœ… å¹¶å‘è¯»å†™ä¿æŠ¤

### 6. é”™è¯¯å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯æ£€æµ‹
- âœ… éƒ¨åˆ†ä¼ è¾“å¤„ç†
- âœ… è¶…æ—¶å’Œé‡è¯•
- âœ… èµ„æºæ¸…ç†

## ğŸ“ æ‰©å±•ç»ƒä¹ 

å¦‚æœä½ æƒ³è¿›ä¸€æ­¥å­¦ä¹ ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹æ”¹è¿›ï¼š

### åˆçº§
1. âœï¸ æ·»åŠ å‘½ä»¤è¡Œå‚æ•°éªŒè¯
2. âœï¸ æ”¹è¿›æ—¥å¿—è¾“å‡ºæ ¼å¼
3. âœï¸ æ·»åŠ ä¸‹è½½è¿›åº¦æ¡
4. âœï¸ æ”¯æŒä¼˜é›…å…³é—­ï¼ˆCtrl+C å¤„ç†ï¼‰

### ä¸­çº§
5. âœï¸ å®ç°ç‰‡æ®µçš„ SHA-1 æ ¡éªŒå’ŒéªŒè¯
6. âœï¸ æ·»åŠ ä¸‹è½½é€Ÿåº¦é™åˆ¶
7. âœï¸ æ”¯æŒæ–­ç‚¹ç»­ä¼ 
8. âœï¸ å®ç° Choking/Unchoking ç®—æ³•
9. âœï¸ æ·»åŠ  Peer é»‘åå•æœºåˆ¶

### é«˜çº§
10. âœï¸ å®ç° DHTï¼ˆåˆ†å¸ƒå¼å“ˆå¸Œè¡¨ï¼‰å»é™¤ Tracker ä¾èµ–
11. âœï¸ æ”¯æŒ UDP åè®®ï¼ˆuTPï¼‰
12. âœï¸ å®ç° .torrent æ–‡ä»¶è§£æï¼ˆBencodeï¼‰
13. âœï¸ æ·»åŠ åŠ å¯†æ”¯æŒï¼ˆé˜²æ­¢ ISP é™é€Ÿï¼‰
14. âœï¸ å®ç° WebRTC æ•°æ®é€šé“æ”¯æŒ

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸‹è½½é€Ÿåº¦å¾ˆæ…¢ï¼Ÿ

**A:** è¿™æ˜¯ä¸€ä¸ªæ•™è‚²é¡¹ç›®ï¼Œä¼˜åŒ–ä¸æ˜¯é‡ç‚¹ã€‚å®é™… BitTorrent ä½¿ç”¨äº†è®¸å¤šä¼˜åŒ–æŠ€æœ¯ï¼š
- Pipeline è¯·æ±‚ï¼ˆä¸€æ¬¡è¯·æ±‚å¤šä¸ªç‰‡æ®µï¼‰
- æ™ºèƒ½ç‰‡æ®µé€‰æ‹©ç®—æ³•
- è¿æ¥æ± ç®¡ç†
- æ‹¥å¡æ§åˆ¶

### Q2: å¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ

**A:** ä¸å¯ä»¥ï¼è¿™åªæ˜¯ä¸€ä¸ªå­¦ä¹ é¡¹ç›®ï¼Œç¼ºå°‘è®¸å¤šå…³é”®ç‰¹æ€§ï¼š
- æ²¡æœ‰åŠ å¯†
- æ²¡æœ‰èº«ä»½éªŒè¯
- æ²¡æœ‰ DDoS é˜²æŠ¤
- æ²¡æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†
- æ²¡æœ‰æ€§èƒ½ä¼˜åŒ–

### Q3: æ”¯æŒ Windows å—ï¼Ÿ

**A:** ä»£ç ä½¿ç”¨ POSIX APIï¼Œéœ€è¦ä¿®æ”¹æ‰èƒ½åœ¨ Windows ä¸Šè¿è¡Œï¼š
- åŒ…å« `<winsock2.h>` è€Œä¸æ˜¯ `<arpa/inet.h>`
- è°ƒç”¨ `WSAStartup()` åˆå§‹åŒ–
- ä½¿ç”¨ `closesocket()` è€Œä¸æ˜¯ `close()`

### Q4: å¦‚ä½•è°ƒè¯•ï¼Ÿ

**A:** å‡ ä¸ªå»ºè®®ï¼š
1. æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼ˆæ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—ï¼‰
2. ä½¿ç”¨ `strace` è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨
3. ä½¿ç”¨ `tcpdump` æˆ– Wireshark æŠ“åŒ…
4. ä½¿ç”¨ `gdb` è°ƒè¯•å™¨

### Q5: ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å›ºå®šçš„æ–‡ä»¶å¤§å°å‚æ•°ï¼Ÿ

**A:** è¿™æ˜¯ç®€åŒ–è®¾è®¡ã€‚çœŸå®çš„ BitTorrent ä½¿ç”¨ .torrent æ–‡ä»¶å­˜å‚¨å…ƒæ•°æ®ï¼ˆæ–‡ä»¶å¤§å°ã€ç‰‡æ®µæ•°é‡ã€SHA-1 æ ¡éªŒå’Œç­‰ï¼‰ã€‚

## ğŸ”— ç›¸å…³èµ„æº

### BitTorrent åè®®
- [BitTorrent å®˜æ–¹è§„èŒƒ](http://www.bittorrent.org/beps/bep_0003.html)
- [éå®˜æ–¹ BitTorrent åè®®è§„èŒƒ](https://wiki.theory.org/BitTorrentSpecification)

### Socket ç¼–ç¨‹
- [Beej's Guide to Network Programming](https://beej.us/guide/bgnet/)
- [POSIX Socket API å‚è€ƒ](https://man7.org/linux/man-pages/man7/socket.7.html)

### C++ å¤šçº¿ç¨‹
- [C++ Concurrency in Action](https://www.manning.com/books/c-plus-plus-concurrency-in-action)
- [cppreference - Thread support library](https://en.cppreference.com/w/cpp/thread)

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ç”¨äºæ•™è‚²ç›®çš„ã€‚

## ğŸ‘¨â€ğŸ’» ä½œè€…

è¿™æ˜¯ä¸€ä¸ª C++ ç½‘ç»œç¼–ç¨‹å­¦ä¹ é¡¹ç›®ã€‚

---

**Happy Learning! ğŸ‰**

å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ª â­ï¼
